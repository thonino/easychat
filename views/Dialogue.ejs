<!DOCTYPE html>
<html>
<head>
  <%- include('./partials/link') %>
  <link rel="stylesheet" href="/public/css/styles.css">
  <title>Chat</title>
</head>
<body>
  <div class="grid-container bg-white">
    <div class="topbar">
      <%- include('./partials/nav'); %>
    </div>
    <div class="bg-dark-less text-center p-0 sidebar d-none d-md-block">
      <%- include('./partials/contact'); %>
      <div class="link">
        <a href="/addfriend" class="btn btn-success btn-sm d-flex align-items-center fw-bold p-0 gap-2 px-1">
          <i class="bi bi-person-fill-add fs-4"></i>
          Ajouter
        </a>
      </div>
    </div>
    <div class="d-flex flex-column main-content"> 
      <div class="bg-dark-less px-2">
        <div class="d-flex justify-content-between align-items-center py-2">
          <!-- Add friend -->
          <div>
            <a href="/addfriend" class="btn btn-success btn-sm d-md-none">
              <i class="bi bi-plus-lg"></i>
            </a>
          </div>
          <!-- Offcanvas toggle button for smaller screens -->
          <div class="d-flex justify-content-between align-items-center text-light">
            <span class="me-2 fst-italic text-info-light text-capitalize">
              A : 
              <span class="text-info fw-bold">
                <%= chatting && friends.includes(chatting) ? chatting : 'Destinataire' %>
              </span>
            </span>
            <button class="btn btn-light btn-sm d-md-none text-secondary text-capitalize fw-bold" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
              Chat
              <i class="bi bi-chat-square-text-fill"></i>
            </button>
          </div>
          <!-- Options -->
          <div>
            <button id="toggle" class="btn btn-light btn-sm text-secondary">
              <i class="bi bi-gear-fill"></i>
            </button>
          </div>
        </div>
      </div>        
      <div class="d-flex flex-column overflow-hidden">
        <div id="messageBox" class="d-flex reverseMessage overflow-y-auto mb-3">
          <% messagesFilter.reverse().forEach(message => { %>
            <div class="text-center fw-bold fst-italic">
              <span class="fs-6 text-muted fw-light">
                <%= message.datetime %>
              </span>
              <% if (message.expediteur === user.pseudo) { %>
                <div class="d-flex justify-content-end align-items-center fs-5 bg-success-light pe-2 gap-2 ">
                  <div class="d-flex flex-row gap-2 align-items-center">
                    <p class="text-capitalize text-success m-2">
                      <%= message.expediteur %> :
                    </p>
                    <p class="fw-light text-dark m-2">
                      <%= message.message %>
                    </p>
                  </div>
                  <div class="cible hidden">
                    <div class="d-flex justify-content-center">
                      <div>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#editMessageModal<%= message._id %>">
                          <i class="bi bi-pencil-square"></i>
                        </button>
                      </div>
                      <div>
                        <button type="button" class="btn btn-danger btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#deleteMessageModal<%= message._id %>">
                          <i class='bi bi-trash'></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              <% } else { %>
                <div class="d-flex fs-5 bg-info-light align-items-center ps-2 gap-2">
                  <div class="d-flex justify-content-start align-items-center "> 
                    <div class="cible hidden">
                      <button type="button" class="btn btn-danger btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#deleteMessageModal<%= message._id %>">
                        <i class='bi bi-trash'></i>
                      </button>
                    </div>
                    <div class="d-flex flex-row gap-2 align-items-center">
                      <p class="fs-5 text-capitalize text-info m-2">
                        <%= message.expediteur %> :
                      </p>
                      <p class="fw-light text-dark m-2">
                        <%= message.message %>
                      </p>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          <% }) %>
        </div>        
        <div class="below-content bg-dark-75 p-3">
          <form class="d-flex justify-content-center align-items-center" method="POST" action="/message">
            <textarea id="textInput" class="form-control txt-area" name="message" rows="3" required></textarea>
            <input type="hidden" name="destinataire" value="<%= chatting %>">
            <input type="hidden" name="expediteur" value="<%= user.pseudo %>">
            <input type="hidden" name="datetime" value="<%= heure %>">
            <button id="sendButton" type="submit" class="btn btn-success ms-2">
              <i class="bi bi-send fs-3"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
    <div id="modalsContainer"></div>
    <%- include('./partials/modalMessage'); %>
    <%- include('./partials/offcanvas'); %>
    <script> var userPseudo = "<%= user.pseudo.toLowerCase() %>"; </script>
    <script src="/public/js/dialogue.js"></script>
    <script src="/socket.io/socket.io.js"></script>
  </body>
</html>
